{
  "kind": "build_request",
  "title": "Fully auto-resolved admin gate rewrite (useEffect + imperative async flow)",
  "projectName": "Game Vault",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-111",
      "text": "Rewrite `frontend/src/components/AdminAccessControl.tsx` with a fully auto-resolved, non-looping sequential gate using a `useEffect` + local state imperative async flow. The component must: (1) immediately render a 'Please log in via Internet Identity' prompt if `isAuthenticated` is false — do not show a spinner or form; (2) once `isAuthenticated` is true, run a single `useEffect` that imperatively calls the backend actor's `getUsername` function directly (NOT via React Query) to retrieve the stored username for the authenticated principal; (3) if the resolved username is an empty string or null/undefined, render the `ProfileSetupModal` to trigger username creation — do not spin; (4) once a non-empty username string is confirmed, immediately call `isAdminUsername` with that exact username string — never pass a principal, undefined, or null; (5) as soon as both calls complete, transition immediately and permanently to either `'granted'` (render children) or `'denied'` (render `AccessDeniedScreen`) using a local `status` state variable typed `'loading' | 'granted' | 'denied' | 'unauthenticated' | 'no-username'`; (6) the `useEffect` must include a `hasRun` ref guard (`if (hasRun.current) return; hasRun.current = true;`) to ensure it executes exactly once per authentication session, preventing re-entry and infinite loops; (7) show a loading spinner only while `status === 'loading'`; (8) do NOT use chained React Query `enabled` flags, `useIsAdminUsername`, or `useUsername` hooks for the gate decision — all async work must be imperative inside the single `useEffect`; (9) apply the sunset theme (dusk-bg/dusk-mid backgrounds, sunset-gold/sunset-orange accent colours, Orbitron/Rajdhani fonts, sunset glow effects) to the loading spinner, login prompt, and any intermediate states.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "fully auto-resolved gate (option 2 from the last message): once you're logged in via Internet Identity, the component silently fetches your stored username ('Frosty'), calls `isAdminUsername` with it imperatively inside a single `useEffect` with a run-once guard, and transitions immediately to 'access granted'",
          "AdminPanelPage.tsx will be stripped of any internal async gates so it renders its tabs unconditionally the moment access is granted"
        ]
      },
      "acceptanceCriteria": [
        "When an unauthenticated user navigates to /admin, a 'Please log in via Internet Identity' prompt is shown immediately — no spinner, no form",
        "When an authenticated user with stored username 'Frosty' navigates to /admin, the component automatically fetches the username and calls isAdminUsername without any manual input",
        "If isAdminUsername returns true, the admin panel content (children) renders immediately",
        "If isAdminUsername returns false, AccessDeniedScreen renders immediately",
        "If the authenticated user has no username, ProfileSetupModal is triggered instead of a spinner",
        "The useEffect executes exactly once per authentication session — navigating away and back does not trigger duplicate calls or loops",
        "No chained React Query enabled flags or useIsAdminUsername/useUsername hooks are used for the gate decision",
        "A loading spinner is shown only during the brief in-flight period while getUsername or isAdminUsername calls are pending",
        "The component never enters a perpetual spinning/verifying state"
      ]
    },
    {
      "id": "REQ-112",
      "text": "Audit and rewrite `frontend/src/pages/AdminPanelPage.tsx` to confirm it contains zero internal async gates, `isAdminUsername` calls, loading states, `useEffect` checks, or 'verifying access' state logic of its own. The page must render its tabbed content (Products, Orders, Payments, Admins, Subscriptions, Settings) immediately and unconditionally as soon as `AdminAccessControl` renders its children. Remove any redundant admin checks, verifying-access states, or internal async logic that could produce a perpetual loading state independent of `AdminAccessControl`.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "AdminPanelPage.tsx will be stripped of any internal async gates so it renders its tabs unconditionally the moment access is granted"
        ]
      },
      "acceptanceCriteria": [
        "AdminPanelPage.tsx contains no isAdminUsername calls, no useEffect with async access checks, and no internal loading/verifying states",
        "Once AdminAccessControl renders its children, the Products tab (default active tab) is visible immediately",
        "All tabs — Products, Orders, Payments, Admins, Subscriptions, Settings — are rendered without any additional async gating",
        "No 'Verifying access…' or spinner state originates from AdminPanelPage.tsx itself"
      ]
    },
    {
      "id": "REQ-113",
      "text": "Audit `frontend/src/hooks/useQueries.ts` to ensure no query or hook configuration can cause `AdminAccessControl.tsx` to enter an infinite re-fetch loop. If `useUsername`/`getUsername` or `useIsAdminUsername` hooks are still present for other consumers, set their `staleTime` to at least 60 000 ms and `retry` to 1. Confirm that none of these hooks are wired into `AdminAccessControl`'s access-gating logic after the REQ-111 rewrite — the admin gate must rely solely on the imperative actor calls (`getUsername` and `isAdminUsername`) inside the `useEffect`.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ]
      },
      "acceptanceCriteria": [
        "Any useUsername / getUsername query hook remaining in useQueries.ts has staleTime ≥ 60 000 ms and retry = 1",
        "Any useIsAdminUsername query hook remaining in useQueries.ts has staleTime ≥ 60 000 ms and retry = 1",
        "Neither hook is imported or called inside AdminAccessControl.tsx for the gate decision",
        "No query configuration in useQueries.ts triggers repeated background refetches that could loop the admin gate"
      ]
    }
  ],
  "constraints": [
    "Do not modify any files listed under frontend.immutablePaths",
    "All async gate logic in AdminAccessControl.tsx must be imperative (direct actor calls inside useEffect), not driven by chained React Query enabled flags",
    "The useEffect in AdminAccessControl.tsx must run exactly once per authentication session — use a hasRun ref guard",
    "Do not remove or alter the backend isAdminUsername or getUsername functions",
    "The 'Game Vault' red → purple → orange gradient text must remain unchanged"
  ],
  "nonGoals": [
    "Adding any new backend functions or changing the backend data model",
    "Changing the checkout, storefront, or subscription pages",
    "Introducing a manual username-entry form in the admin gate",
    "Modifying the loading screen or any page other than AdminAccessControl.tsx, AdminPanelPage.tsx, and useQueries.ts"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}