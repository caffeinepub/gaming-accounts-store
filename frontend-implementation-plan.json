{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Step 2: Payments Tab, Order Approval System & UK Gift Card Checkout Updates",
  "requirements": [
    {
      "id": "REQ-76",
      "summary": "Add React Query hooks for order approval and buyer order queries",
      "acceptanceCriteria": [
        "`useApproveOrder` mutation calls `approveOrder` on the actor, throws on `#err`, invalidates orders cache on success",
        "`useDeclineOrder` mutation calls `declineOrder` on the actor, throws on `#err`, invalidates orders cache on success",
        "`useOrdersByBuyer` query calls `getOrdersByBuyer` with the authenticated principal and is only enabled when authenticated",
        "All hooks are exported from `useQueries.ts`"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Add three new React Query hooks: `useApproveOrder()` mutation that calls `actor.approveOrder(orderId)`, unwraps the Result variant, throws an Error on `#err`, and invalidates the 'orders' query key on success; `useDeclineOrder()` mutation that calls `actor.declineOrder(orderId)`, unwraps the Result variant, throws an Error on `#err`, and invalidates the 'orders' query key on success; `useOrdersByBuyer(principal: Principal)` query that calls `actor.getOrdersByBuyer(principal)` and is only enabled when the principal is provided and the user is authenticated. Export all three hooks."
        }
      ]
    },
    {
      "id": "REQ-77",
      "summary": "Capture UK Gift Card number and balance fields during checkout",
      "acceptanceCriteria": [
        "GiftCardPayment step renders a 'Gift Card Number' input field",
        "GiftCardPayment step renders a 'Gift Card Balance' input field",
        "Both fields are required — form cannot be submitted with empty values",
        "Captured values are passed up to the checkout flow and included in the `placeOrder` call",
        "The existing gift card code validation logic is preserved"
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/checkout/GiftCardPayment.tsx",
          "operation": "modify",
          "description": "Add two new controlled input fields to the gift card payment form: 'Gift Card Number' (text input) and 'Gift Card Balance' (text input or select dropdown). Add local state to track these values. Validate that both fields are filled before enabling the confirm button. Pass these captured values up to the parent component via the onConfirm callback or a new prop callback (e.g., onGiftCardDataChange). Preserve the existing gift card code validation logic that checks the code against 'GVGIFT2025'."
        }
      ]
    },
    {
      "id": "REQ-78",
      "summary": "Update order placement to include UK Gift Card fields",
      "acceptanceCriteria": [
        "`placeOrder` mutation payload includes `giftCardNumber` and `giftCardBalance` fields",
        "Gift card checkout correctly passes the captured number and balance",
        "Non-gift-card checkouts pass empty strings for these fields",
        "Order is persisted with correct gift card data in the backend"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Update the `usePlaceOrder` mutation to accept two new optional parameters: `giftCardNumber` and `giftCardBalance`. Modify the `actor.addOrder()` call to pass these values as the 5th and 6th arguments (after `approvalStatus`). Default both parameters to empty strings if not provided."
        },
        {
          "path": "frontend/src/pages/CheckoutPage.tsx",
          "operation": "modify",
          "description": "Add local state to track `giftCardNumber` and `giftCardBalance` captured from the GiftCardPayment component. Update the GiftCardPayment component usage to pass a callback that updates this state when the user enters gift card details. Modify the final order placement call to pass `giftCardNumber` and `giftCardBalance` to the `usePlaceOrder` mutation when the payment method is 'ukGiftCard', and pass empty strings for all other payment methods."
        }
      ]
    },
    {
      "id": "REQ-79",
      "summary": "Create PaymentsManager admin component for order approval workflow",
      "acceptanceCriteria": [
        "All orders are listed with buyer username, email, contact info, product name, and payment method",
        "Approval status is displayed as a colour-coded badge per order",
        "Gift card orders display the gift card number and balance columns/fields",
        "Approve and Decline buttons are present per order and call the correct mutations",
        "Success and error toast notifications appear after approve/decline actions",
        "Approved and declined orders immediately reflect updated status in the UI after mutation (cache invalidation)",
        "Sunset theme applied consistently"
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/admin/PaymentsManager.tsx",
          "operation": "create",
          "description": "Create a new React component that fetches all orders using the existing `useGetAllOrders()` query hook. Display each order in a responsive table or card list with columns/fields for: buyer username, buyer email, buyer contact, product name (fetched using `useGetProductById(order.productId)`), payment method badge (using the existing payment method badge logic from OrderManager), approval status badge (amber for `#pending`, green for `#approved`, red for `#declined`), and — for orders where `paymentMethod` is 'ukGiftCard' — the `giftCardNumber` and `giftCardBalance` fields. For each order, render 'Approve' and 'Decline' buttons that call `useApproveOrder` and `useDeclineOrder` mutations respectively, passing the order ID. Show a toast notification (success or error) after each mutation completes. Apply the sunset theme consistently: use dusk-bg/dusk-mid backgrounds, sunset-gold/sunset-orange/sunset-pink accent colours for badges and buttons, and Orbitron/Rajdhani fonts. Handle loading and error states gracefully."
        }
      ]
    },
    {
      "id": "REQ-80",
      "summary": "Add Payments tab to admin panel",
      "acceptanceCriteria": [
        "A 'Payments' tab trigger is visible in the admin panel tab bar",
        "Clicking the Payments tab renders the `PaymentsManager` component",
        "All other existing tabs (Products, Orders, Admins, Subscriptions, Settings) continue to function correctly",
        "The default active tab remains unchanged (Products or whichever was first)"
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/AdminPanelPage.tsx",
          "operation": "modify",
          "description": "Import the new `PaymentsManager` component. Add a new tab trigger labelled 'Payments' to the existing tab list (alongside Products, Orders, Admins, Subscriptions, Settings). Add a corresponding tab content panel that renders `<PaymentsManager />` when the Payments tab is active. Ensure the new tab does not change the default active tab or disrupt the existing tab order."
        }
      ]
    },
    {
      "id": "REQ-81",
      "summary": "Display live order approval status on order confirmation page",
      "acceptanceCriteria": [
        "OrderConfirmationPage displays an 'Order Status' section showing the current approvalStatus",
        "Pending status renders in amber/gold colour",
        "Approved status renders in green colour",
        "Declined status renders in red colour",
        "The status is fetched live from the backend (not just from local state)",
        "A React Query refetch interval ensures the status updates without a full page reload"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Update the `useGetOrderById(orderId)` query hook to accept an optional `refetchInterval` configuration parameter. When provided, pass this interval to the React Query `refetchInterval` option so the query automatically refetches at the specified interval (e.g., 30000 milliseconds)."
        },
        {
          "path": "frontend/src/pages/OrderConfirmationPage.tsx",
          "operation": "modify",
          "description": "Update the `useGetOrderById` call to pass a `refetchInterval` of 30000 (30 seconds). Add a new 'Order Status' section to the page UI that displays the `approvalStatus` field from the fetched order. Render the status as a colour-coded badge: amber/sunset-gold background for 'pending', green background for 'approved', red background for 'declined'. Use a clear label like 'Order Status:' followed by the status text (e.g., 'Pending', 'Approved', 'Declined'). Ensure the status updates reactively when the query refetches."
        }
      ]
    }
  ]
}